name: Documentation

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'docs/**'
      - 'src/**'
      - '.github/workflows/docs.yml'
      - 'pyproject.toml'
  pull_request:
    branches:
      - main
    paths:
      - 'docs/**'
      - 'src/**'
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-docs:
    name: Build Documentation
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.12"
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev,viz]"
        pip install sphinx sphinx-rtd-theme sphinx-autodoc-typehints \
          myst-parser sphinx-copybutton sphinxcontrib-napoleon \
          sphinx-design sphinxext-opengraph

    - name: Create docs directory structure
      run: |
        mkdir -p docs/source/_static
        mkdir -p docs/source/_templates
        mkdir -p docs/build

    - name: Generate Sphinx config if not exists
      run: |
        if [ ! -f docs/source/conf.py ]; then
          cat > docs/source/conf.py << 'EOF'
        # Configuration file for the Sphinx documentation builder.
        import os
        import sys
        sys.path.insert(0, os.path.abspath('../../src'))

        # Project information
        project = 'Market Manipulation Lab'
        copyright = '2025, Market Manipulation Lab Team'
        author = 'Market Manipulation Lab Team'
        release = '0.1.0'

        # General configuration
        extensions = [
            'sphinx.ext.autodoc',
            'sphinx.ext.napoleon',
            'sphinx.ext.viewcode',
            'sphinx.ext.intersphinx',
            'sphinx.ext.mathjax',
            'sphinx_autodoc_typehints',
            'myst_parser',
            'sphinx_copybutton',
            'sphinx_design',
            'sphinxext.opengraph',
        ]

        templates_path = ['_templates']
        exclude_patterns = []

        # Options for HTML output
        html_theme = 'sphinx_rtd_theme'
        html_static_path = ['_static']
        html_logo = None
        html_favicon = None

        html_theme_options = {
            'navigation_depth': 4,
            'titles_only': False,
            'collapse_navigation': False,
        }

        # Napoleon settings
        napoleon_google_docstring = True
        napoleon_numpy_docstring = True
        napoleon_include_init_with_doc = True

        # Autodoc settings
        autodoc_default_options = {
            'members': True,
            'member-order': 'bysource',
            'special-members': '__init__',
            'undoc-members': True,
            'exclude-members': '__weakref__'
        }

        # MyST settings
        myst_enable_extensions = [
            "colon_fence",
            "deflist",
            "tasklist",
        ]

        # Intersphinx mapping
        intersphinx_mapping = {
            'python': ('https://docs.python.org/3', None),
            'numpy': ('https://numpy.org/doc/stable/', None),
            'pandas': ('https://pandas.pydata.org/docs/', None),
        }
        EOF
        fi

    - name: Generate index.rst if not exists
      run: |
        if [ ! -f docs/source/index.rst ]; then
          cat > docs/source/index.rst << 'EOF'
        Market Manipulation Lab Documentation
        =====================================

        Simulador educacional e experimental de microestrutura de mercado e manipulação baseada em ordens.

        .. toctree::
           :maxdepth: 2
           :caption: Contents:

           overview
           installation
           quickstart
           api/index
           examples/index
           contributing

        Features
        --------

        * Simulação de mercado com traders aleatórios
        * Manipuladores configuráveis (pump-and-dump, wash trading)
        * Análise e detecção de manipulação
        * Visualizações interativas
        * Sistema de agentes com Claude

        Indices and tables
        ==================

        * :ref:`genindex`
        * :ref:`modindex`
        * :ref:`search`
        EOF
        fi

    - name: Generate API documentation
      run: |
        mkdir -p docs/source/api
        cat > docs/source/api/index.rst << 'EOF'
        API Reference
        =============

        .. toctree::
           :maxdepth: 2

           core
           manipulation
           visualization
           agents

        EOF

        # Core module
        cat > docs/source/api/core.rst << 'EOF'
        Core Module
        ===========

        .. automodule:: market_lab.core
           :members:
           :undoc-members:
           :show-inheritance:

        Market
        ------

        .. automodule:: market_lab.core.market
           :members:
           :undoc-members:
           :show-inheritance:

        Traders
        -------

        .. automodule:: market_lab.core.traders
           :members:
           :undoc-members:
           :show-inheritance:

        Orders
        ------

        .. automodule:: market_lab.core.orders
           :members:
           :undoc-members:
           :show-inheritance:

        Simulation
        ----------

        .. automodule:: market_lab.core.simulation
           :members:
           :undoc-members:
           :show-inheritance:
        EOF

    - name: Build HTML documentation
      run: |
        cd docs
        sphinx-build -b html source build/html -W --keep-going

    - name: Build PDF documentation
      run: |
        cd docs
        sphinx-build -b latex source build/latex
      continue-on-error: true

    - name: Check documentation
      run: |
        cd docs
        sphinx-build -b linkcheck source build/linkcheck
      continue-on-error: true

    - name: Upload documentation artifacts
      uses: actions/upload-artifact@v4
      with:
        name: documentation
        path: docs/build/html
        retention-days: 30

    - name: Upload Pages artifact
      if: github.ref == 'refs/heads/main'
      uses: actions/upload-pages-artifact@v3
      with:
        path: docs/build/html

  deploy-docs:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: build-docs
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    timeout-minutes: 10

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

  link-check:
    name: Check Documentation Links
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    timeout-minutes: 10

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.12"

    - name: Install dependencies
      run: |
        pip install sphinx sphinx-rtd-theme myst-parser

    - name: Check links
      run: |
        cd docs
        sphinx-build -b linkcheck source build/linkcheck || true

    - name: Upload link check results
      uses: actions/upload-artifact@v4
      with:
        name: linkcheck-results
        path: docs/build/linkcheck
        retention-days: 7
